SurfaceFire = inherit(ActivityBase)
inherit(Object, SurfaceFire)
inherit(Bonus,  SurfaceFire)

SurfaceFire.FIRE_OBJECTS = {
	[1] = {
		{122.177734375,-296.0185546875,1.578125},					
		{125.7333984375,-285.3134765625,1.578125},
		{132.4521484375,-285.4306640625,1.578125},
		{143.15234375,-285.2958984375,1.578125},
		{150.7451171875,-288.2734375,1.578125},
		{158.96875,-294.0400390625,1.578125},
		{155.1240234375,-294.4658203125,5.165593624115},
		{155.1240234375,-294.4658203125,5.165593624115},
		{142.4921875,-315.2939453125,10.735054969788},
		{137.25390625,-310.765625,11.700443267822},
		{132.1123046875,-306.37890625,11.089879989624},
		{134.6533203125,-298.251953125,11.538110733032},
		{95.2197265625,-284.1875,13.490128517151},
		{82.662109375,-284.6025390625,13.667303085327},
		{71.5146484375,-284.771484375,13.77610874176},
		{53.7783203125,-287.1533203125,14.474267959595},
		{76.5693359375,-294.3056640625,1.578125},
		{76.5693359375,-294.3056640625,1.578125},
		{67.2177734375,-293.470703125,1.578125},
		{56.4033203125,-293.728515625,1.5916633605957},
		{48.1201171875,-293.4091796875,1.8000431060791},
		{122.6611328125,-319.009765625,1.578125	},
		{146.1484375,-265.8095703125,9.4838399887085},		
		{146.97265625,-271.2578125,9.4838399887085},
		{143.205078125,-269.2783203125,1.578125},
		{142.9951171875,-266.9921875,6.7843918800354},
		{143.36328125,-261.22265625,1.578125},
		{146.88671875,-259.439453125,4.9634037017822	},	
		{156.3115234375,-263.2705078125,5.4838395118713},
		{157.2060546875,-261.232421875,5.4838395118713},
		{161.1298828125,-262.3115234375,9.4838399887085},
		{160.0615234375,-273.7314453125,9.4838399887085},
		{153.0869140625,-268.2333984375,9.4838399887085	},	
	},
	[2] = {
		{-1849.80, -1671.00, 23.75},
		{-1850.44, -1671.55, 24.98},
		{-1850.31, -1672.89, 24.98},
		{-1846.40, -1671.67, 24.98},
		{-1845.72, -1671.71, 24.98},
		{-1843.83, -1674.16, 24.56},
		{-1841.11, -1674.99, 23.67},
		{-1844.08, -1672.07, 21.75},
		{-1845.51, -1669.05, 21.75},
		{-1846.17, -1664.86, 21.75},
		{-1848.55, -1664.22, 21.75},
		{-1851.12, -1663.89, 21.79},
		{-1852.50, -1664.76, 21.76},
		{-1852.65, -1666.38, 21.75},
		{-1852.33, -1670.36, 21.75},
		{-1853.80, -1669.77, 21.75},
		{-1853.98, -1670.69, 24.72},
		{-1854.52, -1671.88, 24.32},
		{-1854.73, -1673.98, 23.82},
		{-1854.55, -1675.52, 22.45},
		{-1853.59, -1675.14, 21.75},
		{-1848.44, -1667.17, 27.68},
		{-1850.48, -1667.31, 27.68},
		{-1850.98, -1668.37, 27.68},
		{-1847.98, -1666.91, 27.68},
		{-1846.58, -1667.58, 29.50},
		{-1846.50, -1665.36, 29.50},
		{-1850.08, -1670.46, 27.68},
		{-1847.06, -1675.63, 21.76},
		{-1845.39, -1676.50, 22.84},
		{-1843.02, -1675.84, 23.32},
		{-1842.75, -1676.83, 23.23},
		{-1853.32, -1674.76, 22.07},
		{-1876.17, -1695.52, 25.64},
		{-1876.82, -1697.25, 25.52},
		{-1877.64, -1700.88, 21.75},
		{-1876.82, -1700.06, 21.75},
		{-1875.95, -1695.73, 21.75},
		{-1873.74, -1693.98, 21.75},
		{-1872.17, -1694.18, 21.75},
		{-1869.47, -1694.51, 21.75},
		{-1868.69, -1697.11, 21.75},
		{-1868.87, -1699.17, 21.75},
		{-1869.25, -1703.38, 21.75},
		{-1871.01, -1705.24, 21.75},
		{-1873.73, -1704.78, 21.75},
		{-1875.39, -1697.52, 29.28},
		{-1874.71, -1697.76, 29.28},
		{-1874.00, -1699.44, 29.56},
		{-1874.27, -1701.34, 29.89},
		{-1874.71, -1703.99, 30.05},
		{-1873.70, -1705.53, 30.05},
		{-1872.25, -1704.72, 30.05},
		{-1873.71, -1698.84, 29.29},
		{-1873.86, -1696.49, 31.16},
		{-1874.40, -1695.04, 31.16},
		{-1874.37, -1694.13, 31.16},
		{-1870.73, -1694.94, 32.61},
		{-1869.71, -1694.34, 32.61},
		{-1869.60, -1691.37, 32.61},
		{-1869.43, -1688.36, 32.61},
		{-1869.21, -1685.49, 32.32},
		{-1869.07, -1683.42, 31.34},
		{-1899.97, -1660.00, 23.02},
		{-1902.81, -1658.85, 23.02},
		{-1910.20, -1658.27, 23.02},
		{-1911.90, -1658.35, 23.02},
		{-1918.41, -1659.10, 23.02},
		{-1919.67, -1661.04, 23.02},
		{-1919.84, -1671.23, 23.02},
		{-1920.07, -1677.28, 23.02},
		{-1919.74, -1681.13, 23.02},
		{-1914.81, -1682.62, 23.02},
		{-1911.28, -1679.46, 23.02},
		{-1907.23, -1677.19, 23.02},
		{-1905.44, -1680.66, 23.02},
		{-1902.65, -1683.72, 23.02},
		{-1899.37, -1682.14, 23.02},
		{-1899.38, -1677.54, 23.02},
		{-1896.12, -1674.37, 23.02},
		{-1895.15, -1679.31, 23.02},
		{-1891.57, -1675.40, 23.02},
		{-1893.19, -1669.52, 23.02},
		{-1894.42, -1667.81, 23.02},
		{-1896.43, -1665.73, 23.02},
		{-1896.98, -1663.70, 23.02},
		{-1896.59, -1659.41, 23.02},
		{-1895.95, -1661.34, 32.07},
		{-1895.20, -1663.13, 33.30},
		{-1894.58, -1666.94, 34.84},
		{-1895.02, -1668.59, 35.06},
		{-1897.46, -1669.04, 35.12},
		{-1900.82, -1666.58, 34.75},
		{-1906.29, -1664.61, 33.92},
		{-1912.68, -1661.44, 32.15},
		{-1918.34, -1662.06, 32.66},
		{-1920.26, -1668.11, 34.99},
		{-1920.12, -1673.02, 35.21},
		{-1916.29, -1677.18, 34.33},
		{-1910.47, -1680.02, 33.13},
		{-1905.25, -1681.97, 31.60},
		{-1899.61, -1683.16, 30.62},
		{-1896.76, -1681.28, 32.18},
		{-1902.52, -1680.50, 32.82},
		{-1911.59, -1681.25, 32.20},
		{-1917.62, -1682.12, 31.48},
		{-1917.77, -1680.50, 32.82},
		{-1918.43, -1677.83, 34.05},
		{-1922.59, -1686.95, 23.02},
		{-1919.52, -1686.62, 23.02},
		{-1913.94, -1686.62, 23.02},
		{-1904.26, -1686.64, 23.02},
		{-1897.82, -1686.62, 23.02},
		{-1923.91, -1682.46, 23.02},
		{-1922.98, -1674.80, 23.02},
		{-1922.97, -1669.91, 23.02},
		{-1923.10, -1664.33, 23.02},
		{-1922.97, -1658.23, 23.02},
		{-1920.89, -1656.02, 23.02},
		{-1914.26, -1656.11, 23.02},
		{-1907.40, -1655.98, 23.02},
		{-1900.26, -1656.06, 23.02},
		{-1894.73, -1656.03, 23.02},
		{-1892.54, -1659.09, 23.02},
		{-1896.24, -1659.92, 23.02},
		{-1881.06, -1659.24, 21.75},
		{-1878.33, -1661.63, 21.75},
		{-1876.40, -1662.94, 22.68},
		{-1875.91, -1665.77, 24.18},
		{-1874.74, -1666.72, 25.01},
		{-1873.08, -1668.47, 26.39},
		{-1871.59, -1671.14, 28.14},
		{-1870.23, -1672.69, 29.32},
		{-1868.68, -1675.39, 31.11},
		{-1867.04, -1677.43, 32.63},
		{-1865.04, -1679.73, 34.37},
		{-1862.35, -1681.13, 35.92},
		{-1861.78, -1687.69, 39.20},
		{-1861.01, -1688.99, 40.08},
		{-1856.91, -1690.84, 41.59},
		{-1854.22, -1692.97, 41.59},
		{-1851.13, -1695.29, 40.87},
		{-1851.98, -1691.40, 41.93},
		{-1850.36, -1692.28, 40.87},
		{-1848.95, -1694.86, 40.87},
		{-1846.65, -1697.73, 40.84},
		{-1845.41, -1701.47, 40.84},
		{-1849.37, -1701.79, 40.87},
		{-1853.20, -1703.57, 40.87},
		{-1856.39, -1700.08, 40.87},
		{-1859.24, -1697.77, 41.45},
		{-1859.46, -1699.43, 40.83},
		{-1855.23, -1705.49, 40.79},
		{-1851.75, -1708.94, 40.78},
		{-1848.40, -1711.08, 40.94},
		{-1848.31, -1708.53, 41.11},
		{-1845.59, -1710.47, 41.11},
		{-1844.78, -1707.14, 41.11},
		{-1840.06, -1706.42, 41.13},
		{-1844.65, -1703.14, 40.80},
		{-1837.58, -1703.43, 40.58},
		{-1838.60, -1702.27, 39.10},
		{-1842.46, -1697.24, 32.98},
		{-1843.04, -1695.21, 32.48},
		{-1840.76, -1694.48, 32.48},
		{-1837.07, -1699.22, 27.41},
		{-1835.53, -1702.32, 24.11},
		{-1834.41, -1703.88, 23.20},
		{-1835.83, -1704.77, 23.20},
		{-1841.79, -1702.94, 23.20},
		{-1839.75, -1705.84, 23.20},
		{-1843.32, -1698.27, 23.20},
		{-1846.80, -1696.42, 23.20},
		{-1849.34, -1695.73, 23.20},
		{-1846.67, -1695.74, 23.20},
		{-1843.21, -1694.94, 23.20},
		{-1839.24, -1697.60, 23.20},
		{-1836.27, -1700.58, 23.20},
		{-1839.62, -1693.12, 23.20},
		{-1844.14, -1686.35, 23.20},
		{-1851.61, -1689.11, 23.20},
		{-1857.92, -1692.13, 23.20},
		{-1862.10, -1694.98, 23.20},
		{-1860.42, -1698.39, 23.20},
		{-1860.13, -1693.96, 23.20},
		{-1854.11, -1689.84, 23.20},
		{-1848.62, -1688.83, 23.20},
		{-1840.96, -1710.60, 23.20},
		{-1847.91, -1712.88, 23.20},
		{-1854.11, -1709.32, 23.20},
		{-1849.55, -1711.77, 23.20},
		{-1847.15, -1715.68, 23.20},
		{-1840.65, -1710.06, 23.20},
		{-1859.17, -1714.18, 21.75},
		{-1854.06, -1707.13, 25.37},
		{-1852.99, -1705.43, 25.37},
		{-1856.10, -1701.86, 23.20},
		{-1856.21, -1703.38, 23.20},
		{-1856.39, -1706.08, 23.20},
		{-1858.00, -1707.34, 22.75},
		{-1865.84, -1714.07, 22.70},
		{-1862.86, -1712.53, 23.17},
		{-1859.29, -1710.64, 24.77},
		{-1852.62, -1705.72, 25.37},
		{-1852.31, -1706.12, 25.37},
	},
}

SurfaceFire.AVAILABLE_FACTIONS = {
	[9] = true,
}

SurfaceFire.CHAT_FACTION = {}

for key, value in pairs ( SurfaceFire.AVAILABLE_FACTIONS ) do table.insert(SurfaceFire.CHAT_FACTION, key) end

function SurfaceFire:constructor(name, id, abbreviation)
	ActivityBase.constructor(self, name, id, abbreviation)
	Bonus.constructor(self)


	-- Timer ( function () self:initActivity() end, 500, 1)

	self.m_FireHandler = bind(self.onFireFinish, self)

	for faction in pairs(SurfaceFire.AVAILABLE_FACTIONS) do
		self:addBonusFaction(faction)
	end
end

function SurfaceFire:FailPhase1()
    if self:getBonus() > 0 then
    	self:Phase2()
	end
end

function SurfaceFire:AfterPhase1()
    for key, value in pairs(self.m_Fires) do
        value:delete()
    end	
    for key, value in pairs(self.m_Blips) do
    	if isElement(value) then
    		value:destroy()
    	end
    end
end

function SurfaceFire:Phase1()
	self:resetBonus()

	self.m_Fires = {}
	self.m_Blips = {}

	self.m_ActiveMission = math.random ( 1, 1 )

	self.m_ActiveMissionTable = SurfaceFire.FIRE_OBJECTS[self.m_ActiveMission]

	self:sendFactionSlideMessage({"Flächenbrand bei " .. getZoneName(unpack(self.m_ActiveMissionTable[1]))}, SurfaceFire.CHAT_FACTION, 500, 3500 )

	self.m_NeededFire = #self.m_ActiveMissionTable
	self.m_DeletedFires = 0

	for key, value in ipairs (self.m_ActiveMissionTable) do
		local tempFire = FireManager:getSingleton():addEntity(value[1], value[2], value[3], 0, 0)
		tempFire.Key = key
		tempFire.onFinish = self.m_FireHandler
		table.insert(self.m_Fires, tempFire)
		table.insert(self.m_Blips, self:sendElementFactionVisibleTo ( Blip  (value[1], value[2], value[3], 0, 1, 50, 50, 50), SurfaceFire.CHAT_FACTION))
	end
end

function SurfaceFire:onFireFinish (fire)
	self.m_DeletedFires = self.m_DeletedFires + 1
	self:addBonus(300)
	self.m_Blips[fire.Key]:destroy()
	if self.m_DeletedFires >= self.m_NeededFire then
		self:nextPhase()
	end
end

function SurfaceFire:Phase2()
	self:sendFactionSlideMessage({"Flächenbrand beendet!", "Gesamter Bonus: " .. self:getBonus() .. " €"}, SurfaceFire.CHAT_FACTION, 500, 3500 )

	self:payBonus()
	self:resetBonus()

	for key, value in ipairs ( getElementsByType("player")) do
		if self.m_BonusFactions[value:getData("Fraktion")] and value:getData("Duty") then
		--	levelup(value, 115)
		end
	end	
end